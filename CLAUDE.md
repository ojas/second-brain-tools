# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

A Rust CLI tool for managing a "second brain" file system. The tool provides multiple subcommands:
- `tree`: Parses JSON tree structures (generated by the `tree` command) and outputs formatted file listings with paths, sizes, and timestamps
- `bookmarks`: Generates and syncs Netscape-style bookmark HTML index files for directories, preserving existing bookmarks and descriptions while adding new files
- `pixie`: Processes photo albums by copying bookmarked files to output folders, generating resized versions with ImageMagick, and creating index.yaml metadata files
- `vault`: Converts Obsidian vault markdown files to publishable format by transforming wikilinks and filtering by frontmatter publish flags

## Development Commands

### Testing
```bash
cargo test
```

### Building
```bash
# Debug build
cargo build

# The binary will be at:
target/debug/second-brain-tools
```

### Running the Tool
```bash
# Show help
cargo run -- --help
target/debug/second-brain-tools --help

# Generate example tree data
tree -J --du -D --timefmt "%Y-%m-%d" . > tree_example.json

# Run tree subcommand with example data
cargo run -- tree tree_example.json
target/debug/second-brain-tools tree tree_example.json

# Run tree subcommand with output redirect
target/debug/second-brain-tools tree ~/sync/trees/tree_sync.json > ~/sync/trees/tree_sync.txt

# Run bookmarks subcommand
# Generate index.html for a folder (non-recursive)
target/debug/second-brain-tools bookmarks /path/to/folder

# Generate with recursive subdirectory processing
target/debug/second-brain-tools bookmarks /path/to/folder --recursive

# Use custom index filename (default: index.html)
target/debug/second-brain-tools bookmarks /path/to/folder --index bookmarks.html

# Short flags
target/debug/second-brain-tools bookmarks /path/to/folder -r -i bookmarks.html

# Run pixie subcommand
# Process photo albums using config file (default: ./pixie.yaml)
cargo run -- pixie
target/debug/second-brain-tools pixie

# Use custom config path
cargo run -- pixie --config /path/to/pixie.yaml
target/debug/second-brain-tools pixie -c examples/pixie.yaml

# Run vault subcommand
# Convert Obsidian vault to publishable markdown
cargo run -- vault /path/to/vault -o /path/to/output
target/debug/second-brain-tools vault ~/Projects/my-vault --output-dir ~/Projects/vault-output

# Short form
target/debug/second-brain-tools vault ~/Projects/my-vault -o ~/site/content
```

## Code Architecture

### Tree Subcommand

**Input Format:**
The tool expects JSON input from the `tree` command with the `-J --du -D --timefmt "%Y-%m-%d"` flags. The JSON structure has:
- First element: Root `TreeNode` with recursive directory structure
- Second element: `ReportNode` with summary statistics (total size, file/directory counts)

**Output Format:**
Tab-separated values: `full_path\tsize\ttime`

### Bookmarks Subcommand

**Input Format:**
- Folder path to scan for files and subdirectories
- Optional `--index` flag to specify index filename (default: index.html)
- Optional `--recursive` flag to include subdirectories

**Output Format:**
Generates Netscape-style bookmark HTML file with structure:
- Files as `<DT><A>` entries with HREF (URL-encoded), ADD_DATE (creation timestamp), and LAST_MODIFIED (modification timestamp)
- Subdirectories as `<DT><H3>` folder entries containing nested `<DL>` lists
- Preserves existing bookmarks and `<DD>` descriptions
- Adds missing files to the end of lists (preserving order)

**Behavior:**
- Skips hidden files (starting with `.`)
- Skips the index file itself
- URL-encodes all file paths
- Preserves existing bookmarks and descriptions when re-running
- Updates folder contents with new files
- Sorts files alphabetically when adding new entries

### Pixie Subcommand

**Input Format:**
- Config file path (default: `./pixie.yaml`) specified with `--config` flag
- Config file defines:
  - `input_folder`: Source directory containing albums (e.g., `~/Pictures/100_FUJI`)
  - `folder_depth`: Optional traversal depth limit (0-64, default: unlimited)
  - `output_folder`: Destination for processed albums (e.g., `~/Projects/photos-cdn`)
  - `index_file_name`: Name of bookmark index files (e.g., `bookmarks.html`)
  - `resize_args`: Map of resize suffix to ImageMagick size spec (e.g., `{"rs": "800x800>", "thumb": "200x200>"}`)
  - `index_transform`: Reserved for future use (currently unused)

**Config File Example (pixie.yaml):**
```yaml
input_folder: ~/Pictures/100_FUJI
folder_depth: 2
output_folder: ~/Projects/photos-cdn
index_file_name: bookmarks.html
resize_args:
  rs: "800x800>"
  thumb: "200x200>"
index_transform: ""
```

**Output Format:**
For each album folder found:
- Copies all bookmarked files to output folder (preserving only album folder name, not full path)
- Generates resized versions of each file (auto-oriented to handle EXIF rotation)
- Copies the bookmark index file
- Generates `index.yaml` metadata file containing:
  - `title`: Album title from H1 tag in bookmark file
  - `photos`: Array of photo metadata with:
    - `filename`: Original filename
    - `w`, `h`: Original dimensions (physical, may not match visual if EXIF rotated)
    - `caption`: Description from DD tag in bookmark file (if present)
    - `sizes`: Map of resize versions with filename, width, height for each

**Behavior:**
- Traverses input folder breadth-first up to specified depth
- Only processes folders containing the index file
- Skips hidden directories (starting with `.`)
- Processes all files from bookmark list (lets ImageMagick handle non-images)
- Logs all ImageMagick commands to stderr for debugging
- Auto-orients resized images using `-auto-orient` flag (rotates pixels to match EXIF, strips orientation tag)
- Preserves originals as-is with EXIF metadata intact
- Handles partial ImageMagick failures gracefully (captures dimensions for successful files)
- Continues to next album if one fails

**Orientation Handling:**
- Original files: Copied unchanged, preserve EXIF orientation metadata
- Resized files: Auto-oriented during processing so pixel data matches intended display
- Original dimensions may not match visual appearance (EXIF rotation)
- Resized dimensions always match visual appearance (orientation baked in)

### Vault Subcommand

**Input Format:**
- Vault directory path containing markdown files
- Output directory path (specified with `-o` or `--output-dir`)

**Output Format:**
Generates publishable markdown files with:
- Converted wikilinks from `[[target]]` to `[target](path)` format
- Alias support: `[[target|display]]` becomes `[display](path)`
- Filtered frontmatter (removes `publish` key)
- Preserved YAML frontmatter for remaining metadata
- Directory structure maintained from vault

**Behavior:**
- Only processes files with `publish: true` in YAML frontmatter
- Builds basename-to-path index for efficient link resolution
- Converts Obsidian-style `[[wikilinks]]` to standard markdown links
- Handles wikilink aliases with pipe syntax (`[[link|display text]]`)
- Removes `publish` key from frontmatter in output files
- Preserves directory structure from vault to output
- Cleans output directory before processing (removes all existing files)
- Read-only operations on vault directory (no modifications to source)
- Skips files without `publish: true` flag (no output generated)

**Frontmatter Handling:**
- Parses YAML frontmatter delimited by `---` markers
- Checks for `publish` boolean field to determine if file should be processed
- Strips `publish` key from output while preserving other metadata
- Gracefully handles files without frontmatter (treated as unpublished)

**Link Resolution:**
- Builds index mapping file basenames to relative paths
- Resolves wikilinks using basename lookup
- Falls back to original target if not found in index
- Omits `.md` extension in output links
- Preserves relative path structure in converted links

### Key Data Structures (src/main.rs)

**CLI Structures:**
- `Cli`: Main CLI parser struct using clap's derive API
- `Commands`: Enum defining available subcommands (Tree, Bookmarks, Pixie, Vault)

**Tree Data Structures:**
- `TreeNode`: Recursive structure representing files/directories with `node_type`, `name`, `size`, `time`, and optional `contents` array
- `ReportNode`: Summary statistics with `size`, `directories`, and `files` counts
- `TreeList`: Top-level wrapper containing one `TreeNode` and one `ReportNode`

**Bookmark Data Structures:**
- `BookmarkEntry`: Represents a single bookmark link with `name`, `href`, `add_date`, `last_modified`, and optional `description`
- `BookmarkFolder`: Represents a folder containing bookmarks with `name`, `last_modified`, and `entries`
- `BookmarkItem`: Enum that can be either a `Link` or a `Folder`
- `BookmarkFile`: Helper struct with `href`, `name`, and optional `caption` for extracted bookmark data

**Pixie Data Structures:**
- `PixieConfig`: Configuration loaded from YAML with `input_folder`, `folder_depth`, `output_folder`, `index_file_name`, `resize_args`, and `index_transform`
- `AlbumFolder`: Represents a discovered album with `path`, `index_path`, `album_name`, and `depth`
- `AlbumIndex`: Root structure for index.yaml output with `title` and `photos` array
- `PhotoInfo`: Metadata for a single photo with `filename`, `w`, `h`, optional `caption`, and `sizes` map
- `SizeInfo`: Dimensions for a resized version with `filename`, `w`, and `h`

Note: `TreeNode.node_type` uses `#[serde(rename = "type")]` because "type" is a Rust keyword.

### Core Functions

**Main:**
- `main()`: Entry point that parses CLI args with clap and dispatches to subcommand handlers

**Tree Command:**
- `handle_tree_command()`: Handles the `tree` subcommand - loads tree JSON and outputs TSV format
- `read_tree_from_file()`: Deserializes JSON file into `TreeList` struct
- `walk_tree()`: Recursively prints tree structure with indentation
- `walk_tree_fullpath()`: Recursively prints full paths with size and timestamp in tab-separated format

**Bookmarks Command:**
- `handle_bookmarks_command()`: Main handler for bookmarks subcommand - orchestrates scanning, parsing, merging, and writing
- `scan_directory()`: Scans a directory for files and subdirectories, returns sorted lists
- `parse_existing_bookmarks()`: Parses existing Netscape bookmark HTML file into `BookmarkItem` vector
- `extract_title_from_bookmarks()`: Extracts H1 title from bookmark HTML file
- `merge_bookmarks()`: Merges existing bookmarks with filesystem entries, preserving order and adding new entries
- `generate_bookmark_html()`: Generates complete Netscape-style bookmark HTML from `BookmarkItem` vector
- `get_file_metadata()`: Extracts creation and modification timestamps from file metadata
- `system_time_to_unix_timestamp()`: Converts `SystemTime` to Unix timestamp

**Pixie Command:**
- `handle_pixie_command()`: Main handler - checks ImageMagick, loads config, finds albums, processes each album
- `log_command()`: Logs shell commands with all arguments to stderr for debugging
- `expand_tilde_path()`: Expands `~` in paths to absolute paths using shellexpand
- `read_pixie_config()`: Loads and validates YAML config file, checks folder_depth bounds
- `find_album_folders()`: Breadth-first traversal to discover albums containing index files
- `extract_bookmark_files()`: Recursively extracts file hrefs and captions from bookmark tree
- `run_imagemagick_resize()`: Runs ImageMagick to create single resized version with auto-orient
- `copy_and_resize_files()`: Copies all files and generates resized versions for each resize spec
- `get_image_dimensions()`: Runs `magick identify` once per folder to get dimensions for all files
- `build_album_index()`: Constructs `AlbumIndex` structure from bookmarks and dimensions
- `process_album()`: Processes single album - copies files, resizes, generates index.yaml

**Vault Command:**
- `handle_vault_command()`: Main handler - validates directories, builds index, processes all markdown files, reports statistics
- `build_vault_index()`: Recursively scans vault directory and builds HashMap mapping basenames to relative paths
- `parse_frontmatter()`: Parses YAML frontmatter from markdown content, returns metadata HashMap and body text
- `convert_wikilinks()`: Transforms Obsidian `[[wikilink]]` syntax to standard markdown `[text](path)`, handles aliases
- `process_vault_file()`: Processes single markdown file - parses frontmatter, checks publish flag, converts links, writes output

## Dependencies

- `serde` (with derive feature): For data structure serialization/deserialization
- `serde_json`: For JSON parsing
- `serde_yaml`: For YAML parsing (pixie config files, index.yaml output, vault frontmatter)
- `clap` (with derive feature): For CLI argument parsing and subcommand management
- `regex`: For HTML parsing in bookmark files and wikilink conversion in vault
- `urlencoding`: For URL-encoding file paths in bookmarks
- `shellexpand`: For tilde (~) expansion in file paths
- `chrono`: For timestamp handling (currently unused but available)

**External Dependencies:**
- `ImageMagick 7.x`: Required for pixie command (image resizing and dimension extraction)

**Note:** Requires Rust 1.74 or newer due to clap 4.5 requirements.

## Security Note

The `.crates_io_token` file contains a crates.io API token and is tracked in `.gitignore`. Do not commit this file.
