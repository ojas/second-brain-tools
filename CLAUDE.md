# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

A Rust CLI tool for managing a "second brain" file system. The tool provides multiple subcommands:
- `tree`: Parses JSON tree structures (generated by the `tree` command) and outputs formatted file listings with paths, sizes, and timestamps
- `bookmarks`: Generates and syncs Netscape-style bookmark HTML index files for directories, preserving existing bookmarks and descriptions while adding new files

## Development Commands

### Testing
```bash
cargo test
```

### Building
```bash
# Debug build
cargo build

# The binary will be at:
target/debug/second-brain-tools
```

### Running the Tool
```bash
# Show help
cargo run -- --help
target/debug/second-brain-tools --help

# Generate example tree data
tree -J --du -D --timefmt "%Y-%m-%d" . > tree_example.json

# Run tree subcommand with example data
cargo run -- tree tree_example.json
target/debug/second-brain-tools tree tree_example.json

# Run tree subcommand with output redirect
target/debug/second-brain-tools tree ~/sync/trees/tree_sync.json > ~/sync/trees/tree_sync.txt

# Run bookmarks subcommand
# Generate index.html for a folder (non-recursive)
target/debug/second-brain-tools bookmarks /path/to/folder

# Generate with recursive subdirectory processing
target/debug/second-brain-tools bookmarks /path/to/folder --recursive

# Use custom index filename (default: index.html)
target/debug/second-brain-tools bookmarks /path/to/folder --index bookmarks.html

# Short flags
target/debug/second-brain-tools bookmarks /path/to/folder -r -i bookmarks.html
```

## Code Architecture

### Tree Subcommand

**Input Format:**
The tool expects JSON input from the `tree` command with the `-J --du -D --timefmt "%Y-%m-%d"` flags. The JSON structure has:
- First element: Root `TreeNode` with recursive directory structure
- Second element: `ReportNode` with summary statistics (total size, file/directory counts)

**Output Format:**
Tab-separated values: `full_path\tsize\ttime`

### Bookmarks Subcommand

**Input Format:**
- Folder path to scan for files and subdirectories
- Optional `--index` flag to specify index filename (default: index.html)
- Optional `--recursive` flag to include subdirectories

**Output Format:**
Generates Netscape-style bookmark HTML file with structure:
- Files as `<DT><A>` entries with HREF (URL-encoded), ADD_DATE (creation timestamp), and LAST_MODIFIED (modification timestamp)
- Subdirectories as `<DT><H3>` folder entries containing nested `<DL>` lists
- Preserves existing bookmarks and `<DD>` descriptions
- Adds missing files to the end of lists (preserving order)

**Behavior:**
- Skips hidden files (starting with `.`)
- Skips the index file itself
- URL-encodes all file paths
- Preserves existing bookmarks and descriptions when re-running
- Updates folder contents with new files
- Sorts files alphabetically when adding new entries

### Key Data Structures (src/main.rs)

**CLI Structures:**
- `Cli`: Main CLI parser struct using clap's derive API
- `Commands`: Enum defining available subcommands (Tree, Bookmarks)

**Tree Data Structures:**
- `TreeNode`: Recursive structure representing files/directories with `node_type`, `name`, `size`, `time`, and optional `contents` array
- `ReportNode`: Summary statistics with `size`, `directories`, and `files` counts
- `TreeList`: Top-level wrapper containing one `TreeNode` and one `ReportNode`

**Bookmark Data Structures:**
- `BookmarkEntry`: Represents a single bookmark link with `name`, `href`, `add_date`, `last_modified`, and optional `description`
- `BookmarkFolder`: Represents a folder containing bookmarks with `name`, `last_modified`, and `entries`
- `BookmarkItem`: Enum that can be either a `Link` or a `Folder`

Note: `TreeNode.node_type` uses `#[serde(rename = "type")]` because "type" is a Rust keyword.

### Core Functions

**Main:**
- `main()`: Entry point that parses CLI args with clap and dispatches to subcommand handlers

**Tree Command:**
- `handle_tree_command()`: Handles the `tree` subcommand - loads tree JSON and outputs TSV format
- `read_tree_from_file()`: Deserializes JSON file into `TreeList` struct
- `walk_tree()`: Recursively prints tree structure with indentation
- `walk_tree_fullpath()`: Recursively prints full paths with size and timestamp in tab-separated format

**Bookmarks Command:**
- `handle_bookmarks_command()`: Main handler for bookmarks subcommand - orchestrates scanning, parsing, merging, and writing
- `scan_directory()`: Scans a directory for files and subdirectories, returns sorted lists
- `parse_existing_bookmarks()`: Parses existing Netscape bookmark HTML file into `BookmarkItem` vector
- `merge_bookmarks()`: Merges existing bookmarks with filesystem entries, preserving order and adding new entries
- `generate_bookmark_html()`: Generates complete Netscape-style bookmark HTML from `BookmarkItem` vector
- `get_file_metadata()`: Extracts creation and modification timestamps from file metadata
- `system_time_to_unix_timestamp()`: Converts `SystemTime` to Unix timestamp

## Dependencies

- `serde` (with derive feature): For data structure serialization/deserialization
- `serde_json`: For JSON parsing
- `clap` (with derive feature): For CLI argument parsing and subcommand management
- `regex`: For HTML parsing in bookmark files
- `urlencoding`: For URL-encoding file paths in bookmarks
- `chrono`: For timestamp handling (currently unused but available)

**Note:** Requires Rust 1.74 or newer due to clap 4.5 requirements.

## Security Note

The `.crates_io_token` file contains a crates.io API token and is tracked in `.gitignore`. Do not commit this file.
